<%
@bar_ids = {}
@shift_config = @department.department_config
@dept_start_hour = @shift_config.schedule_start / 60
@dept_end_hour = @shift_config.schedule_end / 60  #if the day ends after midnight, this should be > 24
@blocks_per_hour = 60 / @shift_config.time_increment
@blocks_per_day = ((@shift_config.schedule_end - @shift_config.schedule_start) / @shift_config.time_increment).to_i
@block_length = 3600 / @blocks_per_hour #seconds
@display_unscheduled_shifts = @shift_config.unscheduled_shifts
@grace_period = @shift_config.grace_period*60 #seconds

#for now, for AJAX
@period_start ||= params[:date].blank? ? Date.parse("last Sunday") : Date.parse(params[:date])
@days_per_period ||= 7 #TODO: make this a setting for an admin



@curr_day = day
@bar_ids[@curr_day] = []
@shifts_outside_display = []
#populate_all_locs(loc, shifts[true], @block_length)
%>

<% render :layout => 'shifts/schedule/day_table_layout' do
#   TODO: gather this info from preferences correctly
#    @loc_groups ||= pref_filter(fetch_location_groups) #need this for ajax sign up
    #@loc_groups = @department.loc_groups
    @loc_groups = current_user.user_config.view_loc_groups.split(', ').map{|lg|LocGroup.find(lg)}

    populate_all_locs(@loc_groups, @block_length)

    @loc_groups.each do |loc_group|
      unless loc_group.locations.empty?
        load_variables(loc_group) %>
        <%= render :partial => 'shifts/schedule/loc', :collection => loc_group.locations.select{|l| l.active}.sort_by(&:priority).reverse %>

        <% unless loc_group == @loc_groups.last %>
          <tr>
            <td class="between_groups" colspan="<%=@blocks_per_day+1%>"></td>
          </tr>
        <% end %>
      <% end %>
    <% end %>
<% end %>

<% unless @shifts_outside_display.empty? %>
  <h4>Shifts outside the display</h4>
  <ul>
    <% @shifts_outside_display.each do |s| %>
      <li><%= link_to s.short_name, (s.report ? shift_report_path(s) : shift_path(s)) -%></li>
    <% end %>
  </ul>
<% end %>

